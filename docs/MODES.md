# Режимы и параметры

- Подготовка аудио
  - canonical (по умолчанию): WAV PCM_S16LE 16 кГц mono.
  - vendor: строго по таблице производителя, при несовпадении — fallback в canonical.

- Транспорт
  - gRPC async: быстро, чувствителен к таймаутам при длинных/многих загрузках.
  - HTTP async: более устойчив на длинных сериях.

- Чанкование
  - Рекомендуемо: 120–300 с. При сетевых сбоях — уменьшать.
  - Fallback per-chunk: gRPC → при ошибке → HTTP, не меняя аудио.

- Диризация
  - Только на сервисе (speaker_separation_options.enable=true).
  - Маппинг имён — по фразам/regex (постобработка).

- Дедупликация сегментов
  - Включена по умолчанию: удаляет дублирующиеся/очень похожие сегменты.
  - Дефолтные пороги: overlap=0.6, sim=0.85.
  - Управление через ENV:
    - SSR_DEDUP=0 отключить (по умолчанию включено).
    - SSR_DEDUP_OVERLAP=0.6 задать порог перекрытия по времени [0..1].
    - SSR_DEDUP_SIM=0.85 задать порог текстовой схожести [0..1].
  - В smart-режиме план кейса может задавать `dedup.enable/overlap/sim` — они применяются автоматически.

- Матрица выбора
  - Короткие файлы (<5 мин): gRPC без чанков.
  - Длинные (≥5 мин) или нестабильная сеть: canonical + chunked 120–300 c + gRPC→HTTP per-chunk.
  - Сохранить оригинал без перекодирования: vendor (если параметры поддержаны), иначе fallback в canonical.

## Zoom H2n: парные стерео-файлы (MS/XY)

- Сценарий: рекордер H2n пишет сразу 2 стерео-файла (MS и XY), где часть речи дублируется.
- Рекомендация: распознавать оба файла отдельно и объединять с безопасным soft‑dedup (дубликаты помечаются, не удаляются).

- Запуск автоматизации (пример):
  ```bash
  venv/bin/python scripts/h2n_pair_process.py \
    "/path/SR008MS.WAV" \
    "/path/SR008XY.WAV" \
    "Result/SR008_merged_safe_soft.md"
  ```

- Что делает скрипт:
  - Прогоняет оба входа через canonical 16k mono (gRPC → fallback HTTP, без чанков).
  - Находит norm.json для обоих.
  - Сливает и рендерит общий Markdown.
  - Помечает возможные дубли как “(возможный дубль) …”.

- Профиль дедупа (по умолчанию в скрипте):
  - SSR_DEDUP_SIM=0.9
  - SSR_DEDUP_OVERLAP=0.7
  - SSR_DEDUP_MAX_SHIFT=2.0
  - SSR_DEDUP_SAME_SPEAKER_ONLY=1
  - SSR_DEDUP_CONTAIN=0.9
  - SSR_DEDUP_SOFT=1

- Кейс: docs/KB/cases/zoom_h2n_dual_soft.yml (подготавливает профиль для таких записей).
